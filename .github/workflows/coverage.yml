name: Upload Code Coverage
on:
  push:
    branches:
      - master
      - dev
  workflow_dispatch:

jobs:
  test:
    title: "Running codecov test"
    type: "freestyle" # Run any command
    image: "node:14.19.0" # The image in which command will be executed
    working_directory: "${{clone}}" # Running command where code cloned
    commands:
      - "npm install --save-dev jest"
      - "npx jest --coverage"
    stage: "test"

  upload_cov:
    title: "Running coverage"
    type: "freestyle" # Run any command
    image: "node:14.19.0" # The image in which command will be executed
    working_directory: "${{clone}}" # Running command where code cloned
    commands:
      - "ci_env=`curl -s https://codecov.io/env`"
      - "npm install codecov -g"
      - "codecov -t ${{CODECOV_TOKEN}} -f ./coverage/ovos_cov.xml"
    stage: "upload"